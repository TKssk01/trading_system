# trading_system v3.0 SPEC (Draft)

## 目的
- SBI証券API（kabusapi）を使って株の自動取引を実行する
- 売買アルゴリズムは v2.0 のロジックを継続利用する
- 取引スタイルはデイトレ/スイング両対応（設定で切替）。初期はデイトレを想定

## 前提
- kabusapi がローカルで稼働している（`http://localhost:18080/kabusapi`）
- APIパスワード/注文パスワードは有効
- 取引対象は東証のみ

## スコープ
- シグナル生成（v2.0ロジック）
- 発注（新規/決済）
- ポジション監視
- 自動停止（安全停止・障害停止）
- ログ/監視

## 非スコープ（v3.0ではやらない）
- PTS対応
- マルチ銘柄の同時運用
- アルゴリズムの改変（v2.0据え置き）
- 高頻度取引向けの最適化

## 取引モード
- `mode = daytrade | swing`
- daytrade: 当日中に全ポジションを強制決済
- swing: 複数日保有を許可

## 機能要件
1. **価格取得**
   - kabusapi `/board` から最新価格を取得
2. **シグナル生成**
   - v2.0 の `interpolated_data` を前提としたシグナル
3. **発注**
   - 新規/返済/逆指値/IOC の注文が可能
4. **ポジション管理**
   - 現在ポジション/注文状況を取得
5. **停止条件**
   - API異常/価格取得不能/ポジション矛盾時に自動停止

## 非機能要件
- 取引安全性: 想定外の連続発注を防止
- 再起動時の状態復元（最低限）
- 監視ログを必ず残す（時刻、価格、シグナル、発注内容）

## 既存構成（v2.0）
- `order_executor.py` に主要な注文処理
- `src/` に簡易的なAPIクライアントと状態管理
- APIパスワードがコード直書き（改善対象）

## 設定項目（確定）
- `SYMBOL`
- `EXCHANGE`
- `DEFAULT_QUANTITY`
- `SLEEP_INTERVAL`
- `MODE (daytrade|swing)`
- `FORCE_CLOSE_TIME`（daytrade）
- `MAX_DAILY_LOSS`（損失制限）

## デフォルト値
- `MODE = daytrade`
- `FORCE_CLOSE_TIME = 14:55`（JST）
- `SYMBOL = 1579`（既存設定を踏襲）
- `MAX_DAILY_LOSS = 1%`（暫定。v2.0ロジックに損失制限がある場合はそれを優先）

## 実行フロー（案）
1. APIトークン取得
2. 価格取得ループ
3. シグナル判定
4. 発注
5. ポジション監視
6. 停止条件で安全終了

## セキュリティ
- APIパスワード/注文パスワードは環境変数に移行する
- ログに認証情報を出力しない

## 未決事項
- v2.0ロジックの詳細確認（損失制限や停止ルール）

